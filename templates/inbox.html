<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#2196F3">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Roxli Mail">
<meta name="msapplication-TileColor" content="#2196F3">
<meta name="msapplication-tap-highlight" content="no">
<title>Roxli Mail - Inbox</title>
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/logo.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/logo.png') }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/logo.png') }}">
<link rel="shortcut icon" href="{{ url_for('static', filename='images/logo.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

<style>
    :root { --accent: #1a73e8; }

@media (prefers-color-scheme: dark) {
        body { background-color: #202124 !important; color: #e8eaed !important; }
        .sidebar { background-color: #2d2e30 !important; border-right: 1px solid #3c4043 !important; }
        .email-item:hover { background-color: #3c4043 !important; }
        .dropdown { background-color: #2d2e30 !important; color: #e8eaed !important; border: 1px solid #3c4043 !important; }
        .dropdown-header { background-color: #2d2e30 !important; color: #e8eaed !important; border-bottom: 1px solid #3c4043 !important; }
        .dropdown-item { color: #e8eaed !important; }
        .dropdown-item:hover { background-color: #3c4043 !important; }
        .dropdown-divider { background: #3c4043 !important; }
        .dropdown-name { color: #e8eaed !important; }
        .dropdown-email, .dropdown-section-title { color: #9aa0a6 !important; }
        .account-name { color: #e8eaed !important; }
        .account-email { color: #9aa0a6 !important; }
        #mailSearch, #mobileMailSearch { background-color: #3c4043 !important; color: #e8eaed !important; border: 1px solid #5f6368 !important; }
        .top-bar { background-color: #2d2e30 !important; border-bottom: 1px solid #3c4043 !important; }
        .action-btn:hover { background-color: #3c4043 !important; }
    }
    
    .action-btn:hover {
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .mail-actions {
        display: flex;
        gap: 4px;
        align-items: center;
    }

@media (prefers-color-scheme: light) {
        body { background-color: #ffffff; color: #000000; }
        .sidebar { background-color: #f1f3f4; border-right: 1px solid #dadce0; }
        .email-item:hover { background-color: #f1f3f4; }
        .dropdown { background-color: white; color: black; border: 1px solid #dadce0; }
        .dropdown-item:hover { background-color: #f1f3f4; }
        #mailSearch, #mobileMailSearch { background-color: white; color: black; border: 1px solid #ccc; }
    }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    .sidebar {
        width: 280px;
        display: flex;
        flex-direction: column;
        padding: 10px;
        transition: transform 0.3s ease;
        background-color: inherit;
        z-index: 300;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        transform: translateX(-100%);
    }

    .sidebar.hidden {
        transform: translateX(-100%);
    }
    
    .sidebar.show {
        transform: translateX(0);
    }

    .logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
    }

    .logo img {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        margin-right: 8px;
        object-fit: cover;
    }

    .compose-btn {
        background-color: var(--accent);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 20px;
        margin-bottom: 20px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .menu-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
    }

    .menu-item:hover {
        background-color: rgba(26, 115, 232, 0.1);
    }
    
    .menu-item.active {
        background-color: rgba(26, 115, 232, 0.15);
        color: #1a73e8;
        font-weight: 600;
        border-right: 3px solid #1a73e8;
    }

    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 20px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        z-index: 100;
        background: inherit;
        transition: left 0.3s ease;
    }

    .profile-pic, .profile-initials {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        border: 2px solid rgba(255,255,255,0.15);
        transition: all 0.3s ease;
        overflow: hidden;
        letter-spacing: 0px;
        line-height: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    .profile-pic:hover, .profile-initials:hover {
        transform: scale(1.05);
        border-color: rgba(255,255,255,0.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        background: #fff;
        border: 1px solid #dadce0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-width: 320px;
        max-height: 500px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
    }

    .dropdown-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .dropdown-name {
        font-weight: 600;
        font-size: 14px;
    }
    
    .dropdown-email {
        font-size: 12px;
        color: #5f6368;
    }
    
    .dropdown-divider {
        height: 1px;
        background: #e0e0e0;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        text-decoration: none;
        color: #202124;
        font-size: 14px;
        cursor: pointer;
    }
    
    .dropdown-item:hover {
        background: #f8f9fa;
    }
    
    .dropdown-section-title {
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #5f6368;
        text-transform: uppercase;
    }

    .email-section {
        margin-top: 50px;
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 0;
        transition: margin-left 0.3s ease;
        padding: 5px;
        box-sizing: border-box;
        max-width: 100vw;
        overflow-x: hidden;
    }

    .compose-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        z-index: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .top-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--accent);
        margin-left: 10px;
    }
    
    .mobile-search-container {
        display: none;
    }

@media (max-width: 768px) {
        .top-btn { 
            display: none; 
        }
        
        .mobile-search-container {
            display: flex;
            flex: 1;
            max-width: 60%;
            position: relative;
            margin: 0 10px;
        }
        
        #mobileMailSearch {
            width: 100%;
            padding: 6px 10px 6px 30px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(128,128,128,0.3);
            background-color: rgba(255,255,255,0.1);
            color: inherit;
        }
        
        .mobile-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            font-size: 14px;
            opacity: 0.7;
        }
        
        .desktop-only {
            display: none;
        }
    }

    .email-search {
        padding: 10px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
    }

    #mailSearch {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .email-list {
        flex: 1;
        overflow-y: auto;
    }

    .email-item {
        padding: 8px;
        border-bottom: 1px solid rgba(128,128,128,0.2);
        cursor: pointer;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        transition: background-color 0.2s ease;
        max-width: 100%;
        overflow: hidden;
    }
    
    .email-item.unread {
        background: rgba(26, 115, 232, 0.05);
        font-weight: 600;
    }
    
    .email-checkbox {
        margin-right: 8px;
        cursor: pointer;
    }
    
    .email-star {
        margin-right: 8px;
        cursor: pointer;
        font-size: 16px;
        color: #fdd835;
    }
    
    .email-star:hover {
        transform: scale(1.2);
    }
    
    .account-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
        min-height: 56px;
    }
    
    .account-item:hover {
        background: #f8f9fa;
    }
    
    .account-item:last-child {
        border-bottom: none;
    }
    
    #savedAccountsList {
        max-height: 300px;
        overflow-y: auto;
    }
    
    #savedAccountsList::-webkit-scrollbar {
        width: 6px;
    }
    
    #savedAccountsList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #savedAccountsList::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    #savedAccountsList::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .account-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
    }
    
    .account-info {
        flex: 1;
    }
    
    .account-name {
        font-size: 14px;
        font-weight: 500;
    }
    
    .account-email {
        font-size: 12px;
        color: #5f6368;
    }
    
    @media (prefers-color-scheme: dark) {
        .active-account {
            background: linear-gradient(135deg, rgba(26,115,232,0.2), rgba(26,115,232,0.1));
            border-color: rgba(26,115,232,0.4);
        }
        
        .account-item:hover {
            background-color: rgba(26,115,232,0.15) !important;
        }
        
        .account-logout-btn:hover {
            background-color: #fce8e6 !important;
            color: #ea4335 !important;
            opacity: 1 !important;
        }
        
        .account-item:hover .account-logout-btn {
            opacity: 1;
        }
    }

    .email-avatar {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-initials {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 16px;
        text-transform: uppercase;
    }

    .email-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
        overflow: hidden;
    }

    .email-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
    }

    .email-sender {
        font-weight: 600;
        font-size: 13px;
        color: #202124;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 150px;
    }

    .email-time {
        font-size: 12px;
        color: #5f6368;
        flex-shrink: 0;
    }

    .email-subject {
        font-weight: 500;
        font-size: 13px;
        color: #202124;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-bottom: 2px;
    }

    .email-preview {
        font-size: 12px;
        color: #5f6368;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.3;
        max-width: 100%;
    }

    @media (prefers-color-scheme: dark) {
        .email-sender {
            color: #e8eaed;
        }
        
        .email-subject {
            color: #e8eaed;
        }
        
        .email-time,
        .email-preview {
            color: #9aa0a6;
        }
    }

    .menu-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 8px;
        flex-direction: column;
        gap: 4px;
    }
    
    .menu-toggle-btn:hover {
        background: rgba(26, 115, 232, 0.1);
        border-radius: 50%;
    }
    
    .hamburger-line {
        width: 20px;
        height: 2px;
        background-color: var(--accent);
        transition: all 0.3s ease;
    }

@media (max-width: 768px) {
        .email-section {
            padding: 2px;
        }
        
        .email-item {
            padding: 6px 8px;
            gap: 6px;
            min-height: 50px;
        }
        
        .email-avatar {
            width: 28px;
            height: 28px;
        }
        
        .avatar-initials {
            font-size: 12px;
        }
        
        .email-sender {
            font-size: 12px;
            max-width: 80px;
        }
        
        .email-time {
            font-size: 10px;
            min-width: 35px;
        }
        
        .email-subject {
            font-size: 12px;
            font-weight: 500;
        }
        
        .email-preview {
            font-size: 11px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }
        
        .email-checkbox {
            transform: scale(0.8);
        }
        
        .email-star {
            font-size: 12px;
        }
        
        .email-content {
            gap: 1px;
        }
    }
@media (max-width: 1024px) {
        .email-section {
            margin-left: 0;
        }
        .top-bar {
            left: 0 !important;
        }
        
        .mobile-search-container {
            display: flex;
        }
        .desktop-only {
            display: none;
        }
    }
</style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar hidden" id="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Roxli Mail Logo" style="width: 120px; height: auto;">
            <span style="margin-left: 8px; font-size: 18px; font-weight: bold; color: #1a73e8;">MAIL</span>
        </div>
        <button class="compose-btn" onclick="window.location.href='/compose'">
            <i class="fa-solid fa-pencil"></i> Compose
        </button>
        <div class="menu-item" onclick="setActiveView('all')" data-category="All">All Mail</div>
        <div class="menu-item" onclick="setActiveView('inbox')" data-category="Inbox">Inbox</div>
        <div class="menu-item" onclick="setActiveView('starred')" data-category="Starred">Starred</div>
        <div class="menu-item" onclick="setActiveView('sent')" data-category="Sent">Sent</div>
        <div class="menu-item" onclick="setActiveView('drafts')" data-category="Drafts">Drafts</div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="menu-toggle-btn" aria-label="Toggle Menu" onclick="toggleSidebar()">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </button>

        
        <div class="mobile-search-container">
            <input type="text" id="mobileMailSearch" placeholder="Search mails...">
            <i class="fa-solid fa-search mobile-search-icon"></i>
        </div>
        
        <div style="flex:1"></div>
        <div class="profile-avatar-wrapper" style="position: relative; width: 40px; height: 40px;">
            <div class="profile-initials" onclick="toggleDropdown()" style="background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">
                {{ user.firstName[0] }}{{ user.lastName[0] }}
            </div>
        </div>
        <div class="dropdown" id="profileDropdown">
            <div class="dropdown-header">
                <div class="dropdown-avatar-wrapper" style="position: relative; width: 40px; height: 40px;">
                    <div class="profile-initials" style="background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; width: 40px; height: 40px; border-radius: 50%;">
                        {{ user.firstName[0] }}{{ user.lastName[0] }}
                    </div>
                </div>
                <div>
                    <div class="dropdown-name">{{ user.firstName }} {{ user.lastName }}</div>
                    <div class="dropdown-email">{{ user.email }}</div>
                </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="window.open('https://account.roxli.in', '_blank')">
                <i class="fa-solid fa-user"></i>
                <span>Manage your Account</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-section-title">Switch accounts</div>
            <div id="savedAccountsList"></div>
            <div class="dropdown-item" onclick="addNewAccount()">
                <i class="fa-solid fa-plus"></i>
                <span>Add another account</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="logout()">
                <i class="fa-solid fa-sign-out-alt"></i>
                <span>Sign out</span>
            </div>
        </div>
    </div>

    <!-- Email Section -->
    <div class="email-section">
        <div class="email-search desktop-only">
            <input type="text" id="mailSearch" placeholder="Search mails...">
        </div>
        
        <div id="selectionToolbar" style="display: none; background: #e3f2fd; padding: 8px 16px; border-bottom: 1px solid #bbdefb; align-items: center; gap: 12px;">
            <span id="selectedCount">0 selected</span>
            <button onclick="selectAllEmails()" style="background: none; border: 1px solid #1a73e8; color: #1a73e8; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Select All</button>
            <button onclick="deselectAllEmails()" style="background: none; border: 1px solid #5f6368; color: #5f6368; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Deselect All</button>
            <button onclick="deleteSelectedEmails()" style="background: #ea4335; border: none; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>

        <!-- Notification Permission Banner -->
        <div id="notificationBanner" style="display: none; background: linear-gradient(135deg, #1a73e8 0%, #667eea 100%); color: white; padding: 15px 20px; margin: 10px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 24px;">🔔</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Enable Email Notifications</div>
                    <div style="font-size: 13px; opacity: 0.9;">Get instant alerts when you receive new emails</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="enableNotifications()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 500;">Enable</button>
                    <button onclick="dismissNotificationBanner()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer;">Later</button>
                </div>
            </div>
        </div>

        <div class="email-list" id="mailList">
            <!-- Emails will be loaded here -->
        </div>
    </div>

    <!-- Floating Compose Button -->
    <button class="compose-float-btn" onclick="window.location.href='/compose'">
        <i class="fa-solid fa-pencil"></i> Compose
    </button>

<script>
function toggleDropdown() {
    const menu = document.getElementById('profileDropdown');
    if (menu.style.display === 'block') {
        menu.style.display = 'none';
    } else {
        applyDropdownTheme();
        menu.style.display = 'block';
    }
}

function toggleNotificationCenter() {
    const center = document.getElementById('notificationCenter');
    if (center && center.style.display === 'block') {
        center.style.display = 'none';
    } else if (center) {
        loadNotificationHistory();
        center.style.display = 'block';
    }
}

function loadNotificationHistory() {
    const notificationList = document.getElementById('notificationList');
    if (!notificationList) return;
    
    // Get stored notifications from localStorage
    const storedNotifications = JSON.parse(localStorage.getItem('roxli_notifications') || '[]');
    
    if (storedNotifications.length === 0) {
        notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: #5f6368; font-size: 14px;">No notifications</div>';
        return;
    }
    
    notificationList.innerHTML = storedNotifications.slice(0, 10).map(notif => `
        <div style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="${notif.data && notif.data.email_id ? `window.open('/read/${notif.data.email_id}', '_blank')` : ''}">
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #202124;">${notif.title}</div>
            <div style="font-size: 12px; color: #5f6368; line-height: 1.4;">${notif.body}</div>
            <div style="font-size: 11px; color: #9aa0a6; margin-top: 4px;">${new Date(notif.timestamp * 1000).toLocaleString()}</div>
        </div>
    `).join('');
}

function clearAllNotifications() {
    localStorage.removeItem('roxli_notifications');
    document.getElementById('notificationBadge').style.display = 'none';
    loadNotificationHistory();
}

function updateNotificationBadge() {
    const storedNotifications = JSON.parse(localStorage.getItem('roxli_notifications') || '[]');
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        if (storedNotifications.length > 0) {
            badge.textContent = storedNotifications.length > 99 ? '99+' : storedNotifications.length;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Apply theme to dropdown elements
function applyDropdownTheme() {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const dropdown = document.getElementById('profileDropdown');
    
    if (dropdown && isDark) {
        dropdown.style.backgroundColor = '#2d2e30';
        dropdown.style.color = '#e8eaed';
        dropdown.style.border = '1px solid #3c4043';
        
        dropdown.querySelectorAll('.dropdown-header').forEach(el => {
            el.style.backgroundColor = '#2d2e30';
            el.style.color = '#e8eaed';
            el.style.borderBottom = '1px solid #3c4043';
        });
        
        dropdown.querySelectorAll('.dropdown-item').forEach(el => {
            el.style.color = '#e8eaed';
        });
        
        dropdown.querySelectorAll('.dropdown-divider').forEach(el => {
            el.style.background = '#3c4043';
        });
        
        dropdown.querySelectorAll('.dropdown-name, .account-name').forEach(el => {
            el.style.color = '#e8eaed';
        });
        
        dropdown.querySelectorAll('.dropdown-email, .dropdown-section-title, .account-email').forEach(el => {
            el.style.color = '#9aa0a6';
        });
    }
}

document.addEventListener('click', function(e) {
    const menu = document.getElementById('profileDropdown');
    if (!e.target.closest('.profile-pic') && !e.target.closest('.profile-initials') && !e.target.closest('.dropdown')) {
        menu.style.display = 'none';
    }
});

function filterCategory(category) {
    if (category === 'Starred') {
        document.querySelectorAll('.email-item').forEach(item => {
            const starIcon = item.querySelector('.email-star');
            if (starIcon && starIcon.textContent === '⭐') {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    } else {
        document.querySelectorAll('.email-item').forEach(item => {
            if(category === 'All' || item.dataset.category === category) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

function setupSearchListeners() {
    const desktopSearch = document.getElementById('mailSearch');
    const mobileSearch = document.getElementById('mobileMailSearch');
    
    const performSearch = function(filter) {
        filter = filter.toLowerCase();
        document.querySelectorAll('#mailList .email-item').forEach(function(item) {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(filter) ? '' : 'none';
        });
    };
    
    if (desktopSearch) {
        desktopSearch.addEventListener('input', function() {
            performSearch(this.value);
            if (mobileSearch) mobileSearch.value = this.value;
        });
    }
    
    if (mobileSearch) {
        mobileSearch.addEventListener('input', function() {
            performSearch(this.value);
            if (desktopSearch) desktopSearch.value = this.value;
        });
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('hidden')) {
        sidebar.classList.remove('hidden');
        sidebar.classList.add('show');
    } else {
        sidebar.classList.remove('show');
        sidebar.classList.add('hidden');
    }
}

function refreshEmails() {
    const refreshBtn = document.querySelector('[onclick="refreshEmails()"] i');
    if (refreshBtn) {
        refreshBtn.style.animation = 'spin 1s linear infinite';
    }
    
    loadEmails();
    
    setTimeout(() => {
        if (refreshBtn) {
            refreshBtn.style.animation = '';
        }
        showNotification('Emails refreshed');
    }, 1000);
}

// Add spin animation
if (!document.querySelector('#refresh-animation')) {
    const style = document.createElement('style');
    style.id = 'refresh-animation';
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

function selectAllEmails() {
    document.querySelectorAll('.email-item').forEach(item => {
        if (item.style.display !== 'none') {
            const checkbox = item.querySelector('.email-checkbox');
            if (checkbox) {
                checkbox.checked = true;
                selectedEmails.add(item.dataset.id);
            }
        }
    });
    updateSelectionUI();
    showNotification(`${selectedEmails.size} emails selected`);
}

function deselectAllMails() {
    document.querySelectorAll('.email-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedEmails.clear();
    updateSelectionUI();
}

function logout() {
    fetch('/api/logout', { method: 'POST' })
        .then(() => {
            window.location.href = '/login-required';
        })
        .catch(() => {
            window.location.href = '/login-required';
        });
}

let emails = [];

function loadEmails() {
    fetch('/api/emails')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.emails) {
                emails = data.emails;
                renderEmails();
            } else {
                emails = [];
                renderEmails();
            }
        })
        .catch(error => {
            console.error('Error loading emails:', error);
            document.getElementById('mailList').innerHTML = '<div style="padding: 20px; text-align: center; color: #5f6368;">Loading emails...</div>';
            // Retry after 2 seconds
            setTimeout(loadEmails, 2000);
        });
}

function renderEmails() {
    const emailList = document.getElementById('mailList');
    
    if (emails.length > 0) {
        emailList.innerHTML = emails.map(email => `
            <div class="email-item ${!email.read ? 'unread' : ''}" data-id="${email.id}" data-category="Inbox" onclick="openEmail('${email.id}')">
                <input type="checkbox" class="email-checkbox" onclick="event.stopPropagation(); selectEmail('${email.id}', this.checked)">
                <span class="email-star" onclick="event.stopPropagation(); toggleStar('${email.id}')">${email.starred ? '⭐' : '☆'}</span>
                <div class="email-avatar">
                    <div class="avatar-initials" style="background-color: #667eea;">
                        ${email.from ? email.from[0].toUpperCase() : 'U'}
                    </div>
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <div class="email-sender">${email.from || 'Unknown'}</div>
                        <div class="email-time">${email.time || ''}</div>
                    </div>
                    <div class="email-subject">${email.subject || '(No subject)'}</div>
                    <div class="email-preview">${email.preview ? (email.preview.length > 50 ? email.preview.substring(0, 50) + '...' : email.preview) : ''}</div>
                </div>
            </div>
        `).join('');
    } else {
        emailList.innerHTML = '<div style="padding: 40px; text-align: center; color: #5f6368;">No emails in inbox</div>';
    }
}

let selectedEmails = new Set();

function openEmail(emailId) {
    window.location.href = `/read/${emailId}`;
}

function toggleStar(emailId) {
    const email = emails.find(e => e.id === emailId);
    if (email) {
        const newStarred = !email.starred;
        
        fetch('/api/star-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emailId, starred: newStarred })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                email.starred = newStarred;
                renderEmails();
                showNotification(newStarred ? 'Email starred' : 'Email unstarred');
            }
        });
    }
}

function selectEmail(emailId, checked) {
    if (checked) {
        selectedEmails.add(emailId);
    } else {
        selectedEmails.delete(emailId);
    }
    updateSelectionUI();
}

function selectAllEmails() {
    document.querySelectorAll('.email-item:not([style*="display: none"]) .email-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        selectedEmails.add(checkbox.closest('.email-item').dataset.id);
    });
    updateSelectionUI();
}

function deselectAllEmails() {
    document.querySelectorAll('.email-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedEmails.clear();
    updateSelectionUI();
}

function loadAllEmails() {
    // Load both inbox and sent emails
    Promise.all([
        fetch('/api/emails').then(r => r.json()),
        fetch('/api/sent-emails').then(r => r.json())
    ])
    .then(([inboxData, sentData]) => {
        const allEmails = [];
        
        // Add inbox emails
        if (inboxData.emails) {
            allEmails.push(...inboxData.emails.map(email => ({...email, folder: 'inbox'})));
        }
        
        // Add sent emails
        if (sentData.emails) {
            allEmails.push(...sentData.emails.map(email => ({...email, folder: 'sent'})));
        }
        
        // Sort by timestamp
        allEmails.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        emails = allEmails;
        renderAllEmails();
    })
    .catch(error => {
        console.error('Error loading all emails:', error);
        loadEmails(); // Fallback to inbox only
    });
}

function renderAllEmails() {
    const emailList = document.getElementById('mailList');
    
    if (emails.length > 0) {
        emailList.innerHTML = emails.map(email => {
            const isInbox = email.folder === 'inbox';
            const displayEmail = isInbox ? email.from : `To: ${email.to}`;
            const icon = isInbox ? (email.starred ? '⭐' : '☆') : '📤';
            
            return `
                <div class="email-item ${!email.read && isInbox ? 'unread' : ''}" data-id="${email.id}" data-category="All" onclick="openEmail('${email.id}')">
                    <input type="checkbox" class="email-checkbox" onclick="event.stopPropagation(); selectEmail('${email.id}', this.checked)">
                    <span class="email-star" onclick="event.stopPropagation(); ${isInbox ? `toggleStar('${email.id}')` : ''}">${icon}</span>
                    <div class="email-avatar">
                        <div class="avatar-initials" style="background-color: #667eea;">
                            ${isInbox ? (email.from ? email.from[0].toUpperCase() : 'U') : (email.to ? email.to[0].toUpperCase() : 'U')}
                        </div>
                    </div>
                    <div class="email-content">
                        <div class="email-header">
                            <div class="email-sender">${displayEmail || 'Unknown'}</div>
                            <div class="email-time">${email.time || ''}</div>
                        </div>
                        <div class="email-subject">${email.subject || '(No subject)'}</div>
                        <div class="email-preview">${email.preview ? (email.preview.length > 50 ? email.preview.substring(0, 50) + '...' : email.preview) : ''}</div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        emailList.innerHTML = '<div style="padding: 40px; text-align: center; color: #5f6368;">No emails found</div>';
    }
}

function updateSelectionUI() {
    const count = selectedEmails.size;
    const toolbar = document.getElementById('selectionToolbar');
    const countSpan = document.getElementById('selectedCount');
    
    if (count > 0) {
        toolbar.style.display = 'flex';
        countSpan.textContent = `${count} selected`;
    } else {
        toolbar.style.display = 'none';
    }
}

function deleteSelectedEmails() {
    if (selectedEmails.size === 0) {
        showNotification('No emails selected', 'error');
        return;
    }
    
    if (!confirm(`Delete ${selectedEmails.size} email(s)?`)) return;
    
    const emailIds = Array.from(selectedEmails);
    
    fetch('/api/delete-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emailIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            emails = emails.filter(email => !selectedEmails.has(email.id));
            selectedEmails.clear();
            renderEmails();
            updateSelectionUI();
            showNotification(`${emailIds.length} emails deleted`);
        }
    });
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 60px; right: 20px; z-index: 1000;
        background: ${type === 'error' ? '#ea4335' : '#34a853'};
        color: white; padding: 12px 20px; border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

window.addEventListener('load', function() {
    document.getElementById('sidebar').classList.add('hidden');
    document.querySelector('.top-bar').style.left = '0';
    document.querySelector('.email-section').style.marginLeft = '0';
});

document.addEventListener('DOMContentLoaded', function() {
    setupSearchListeners();
    
    // Force cleanup then load emails
    fetch('/api/cleanup-emails', { method: 'POST' })
        .then(() => {
            setActiveView('inbox'); // Set initial view
            startAutoRefresh(); // Start auto refresh
        })
        .catch(() => {
            setActiveView('inbox');
            startAutoRefresh();
        });
    
    loadSavedAccounts();
    checkFirstTimeUser();
    checkNotificationPermission();
    initializeNotifications();
    updateNotificationBadge();
});



// Check if we should show notification permission banner
function checkNotificationPermission() {
    const dismissed = localStorage.getItem('notification_banner_dismissed');
    const hasPermission = Notification.permission === 'granted';
    
    if (!dismissed && !hasPermission && 'Notification' in window) {
        document.getElementById('notificationBanner').style.display = 'block';
    }
}

// Enable notifications when user clicks enable
function enableNotifications() {
    initializeNotifications();
    dismissNotificationBanner();
}

// Dismiss notification banner
function dismissNotificationBanner() {
    document.getElementById('notificationBanner').style.display = 'none';
    localStorage.setItem('notification_banner_dismissed', 'true');
}

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDummy_Replace_With_Your_Key",
    authDomain: "roxli-mail.firebaseapp.com",
    projectId: "roxli-mail",
    storageBucket: "roxli-mail.appspot.com",
    messagingSenderId: "539072741497",
    appId: "1:539072741497:web:dummy_replace_with_your_id"
};

let messaging = null;

// Initialize Firebase and notifications
function initializeNotifications() {
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        messaging = firebase.messaging();
        
        // Register service worker first
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/firebase-messaging-sw.js', {
                scope: '/'
            })
            .then((registration) => {
                console.log('Service Worker registered:', registration);
                messaging.useServiceWorker(registration);
                
                // Wait for service worker to be ready
                return navigator.serviceWorker.ready;
            })
            .then(() => {
                console.log('Service Worker ready, requesting permission');
                requestNotificationPermission();
            })
            .catch((error) => {
                console.error('Service Worker registration failed:', error);
                requestBrowserNotificationPermission();
            });
        } else {
            console.log('Service Worker not supported, using browser notifications');
            requestBrowserNotificationPermission();
        }
        
        // Handle foreground messages
        messaging.onMessage((payload) => {
            console.log('Foreground FCM message received:', payload);
            showAdvancedNotification({
                title: payload.notification?.title || payload.data?.title || 'New Email',
                body: payload.notification?.body || payload.data?.body || 'You have a new message',
                data: payload.data || {}
            });
        });
        
    } catch (error) {
        console.error('Firebase initialization failed:', error);
        requestBrowserNotificationPermission();
    }
}

// Request FCM token and notification permission
function requestNotificationPermission() {
    console.log('Requesting notification permission...');
    
    Notification.requestPermission().then((permission) => {
        console.log('Notification permission:', permission);
        
        if (permission === 'granted') {
            // Get FCM token
            messaging.getToken({ 
                vapidKey: 'YOUR_VAPID_KEY_HERE'
            })
            .then((currentToken) => {
                if (currentToken) {
                    console.log('FCM Token obtained:', currentToken.substring(0, 20) + '...');
                    
                    // Send token to server with device info
                    const deviceId = localStorage.getItem('device_id') || generateDeviceId();
                    
                    fetch('/api/subscribe-notifications', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            token: currentToken, 
                            type: 'fcm',
                            userAgent: navigator.userAgent,
                            deviceId: deviceId,
                            platform: navigator.platform,
                            isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                        })
                    })
                    .then(response => {
                        console.log('Subscription response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Subscription response:', data);
                        if (data.success) {
                            console.log('FCM subscription successful');
                            showNotification('Push notifications enabled! You\'ll receive alerts for new emails.');
                            
                            // Store token locally for debugging
                            localStorage.setItem('fcm_token', currentToken);
                        } else {
                            console.error('Subscription failed:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error subscribing to FCM:', error);
                    });
                } else {
                    console.log('No FCM registration token available.');
                    requestBrowserNotificationPermission();
                }
            })
            .catch((err) => {
                console.error('Error retrieving FCM token:', err);
                requestBrowserNotificationPermission();
            });
        } else {
            console.log('Notification permission denied or default');
            if (permission === 'default') {
                // Try again after a delay on mobile
                setTimeout(() => {
                    console.log('Retrying notification permission...');
                    requestNotificationPermission();
                }, 2000);
            }
        }
    }).catch(error => {
        console.error('Error requesting notification permission:', error);
        requestBrowserNotificationPermission();
    });
}

function generateDeviceId() {
    const deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now();
    localStorage.setItem('device_id', deviceId);
    return deviceId;
}

// Fallback to browser notifications
function requestBrowserNotificationPermission() {
    console.log('Falling back to browser notifications');
    
    if ('Notification' in window) {
        Notification.requestPermission().then((permission) => {
            if (permission === 'granted') {
                console.log('Browser notification permission granted');
                
                // Subscribe with browser type
                const deviceId = localStorage.getItem('device_id') || generateDeviceId();
                
                fetch('/api/subscribe-notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: 'browser_' + deviceId, 
                        type: 'browser',
                        userAgent: navigator.userAgent,
                        deviceId: deviceId,
                        platform: navigator.platform,
                        isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Browser notifications enabled!');
                    }
                })
                .catch(error => {
                    console.error('Error subscribing browser notifications:', error);
                });
            } else {
                console.log('Browser notification permission denied');
            }
        });
    } else {
        console.log('Browser notifications not supported');
    }
}

async function loadSavedAccounts() {
    try {
        // Get saved accounts from localStorage (from auth popup)
        const savedAccounts = JSON.parse(localStorage.getItem('roxli_accounts') || '[]');
        const loggedInEmails = JSON.parse(localStorage.getItem('roxli_logged_accounts') || '[]');
        const currentEmail = '{{ user.email }}';
        
        // Add current user to logged accounts if not already there
        if (!loggedInEmails.includes(currentEmail)) {
            loggedInEmails.push(currentEmail);
            localStorage.setItem('roxli_logged_accounts', JSON.stringify(loggedInEmails));
        }
        
        const accountsList = document.getElementById('savedAccountsList');
        if (!accountsList) return;
        
        accountsList.innerHTML = '';
        
        // Combine saved accounts with logged emails
        const allAccounts = new Map();
        
        // Add saved accounts (with full user data)
        savedAccounts.forEach(account => {
            if (account.email !== currentEmail) {
                allAccounts.set(account.email, account);
            }
        });
        
        // Add logged emails that might not be in saved accounts
        loggedInEmails.forEach(email => {
            if (email !== currentEmail && !allAccounts.has(email)) {
                const nameParts = email.split('@')[0].split('.');
                const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : 'User';
                const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
                
                allAccounts.set(email, {
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    avatar: `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=667eea&color=fff&size=32&bold=true`
                });
            }
        });
        
        // Display all accounts
        if (allAccounts.size > 0) {
            // Set max height for scrolling if more than 4 accounts
            if (allAccounts.size > 4) {
                accountsList.style.maxHeight = '280px';
                accountsList.style.overflowY = 'auto';
                accountsList.style.scrollbarWidth = 'thin';
            }
            
            allAccounts.forEach(account => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                accountItem.onclick = () => switchToAccount(account.email);
                const hasAvatar = account.avatar && !account.avatar.includes('data:image/svg+xml');
                accountItem.innerHTML = `
                    <div class="account-avatar-wrapper" style="position: relative; width: 32px; height: 32px; flex-shrink: 0;">
                        ${hasAvatar ? 
                            `<img src="${account.avatar}" alt="${account.firstName}" class="account-avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
                            ''
                        }
                        <div class="profile-initials" style="background: linear-gradient(135deg, #667eea, #764ba2); display: ${hasAvatar ? 'none' : 'flex'}; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: white; width: 32px; height: 32px; border-radius: 50%; ${hasAvatar ? 'position: absolute; top: 0; left: 0;' : ''}">
                            ${account.firstName[0]}${account.lastName[0]}
                        </div>
                    </div>
                    <div class="account-info" style="flex: 1; min-width: 0;">
                        <div class="account-name" style="font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${account.firstName} ${account.lastName}</div>
                        <div class="account-email" style="font-size: 12px; color: #5f6368; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${account.email}</div>
                    </div>
                    <button onclick="logoutAccount('${account.email}')" class="account-logout-btn" title="Logout from this device" style="background: none; border: none; color: #9aa0a6; font-size: 16px; cursor: pointer; padding: 4px; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; opacity: 0.7;">×</button>
                `;
                accountsList.appendChild(accountItem);
            });
        }
    } catch (error) {
        console.error('Error loading saved accounts:', error);
    }
}

function addNewAccount() {
    const popup = window.open('https://auth.roxli.in/popup', 'roxli-auth', 'width=400,height=600,scrollbars=yes,resizable=yes');
    
    const messageHandler = function(event) {
        if (event.origin !== 'https://auth.roxli.in') return;
        
        if (event.data.type === 'ROXLI_AUTH_SUCCESS') {
            popup.close();
            window.removeEventListener('message', messageHandler);
            
            // Set token and reload
            fetch('/api/set-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: event.data.token })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Save account to both logged accounts and saved accounts WITHOUT switching
                    const loggedAccounts = JSON.parse(localStorage.getItem('roxli_logged_accounts') || '[]');
                    if (!loggedAccounts.includes(event.data.user.email)) {
                        loggedAccounts.push(event.data.user.email);
                        localStorage.setItem('roxli_logged_accounts', JSON.stringify(loggedAccounts));
                    }
                    
                    // Also save to roxli_accounts for consistency
                    const savedAccounts = JSON.parse(localStorage.getItem('roxli_accounts') || '[]');
                    const existingIndex = savedAccounts.findIndex(acc => acc.email === event.data.user.email);
                    if (existingIndex === -1) {
                        savedAccounts.push(event.data.user);
                    } else {
                        savedAccounts[existingIndex] = event.data.user;
                    }
                    localStorage.setItem('roxli_accounts', JSON.stringify(savedAccounts));
                    
                    // Just reload saved accounts, don't switch sessions
                    loadSavedAccounts();
                    showNotification(`Account ${event.data.user.email} added successfully`);
                }
            });
        }
    };
    
    window.addEventListener('message', messageHandler);
}

function switchToAccount(email) {
    // Try API switch first, fallback to popup if needed
    fetch('/api/switch-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            // Fallback to popup if API switch fails
            openAuthPopupForSwitch(email);
        }
    })
    .catch(() => {
        // Fallback to popup on error
        openAuthPopupForSwitch(email);
    });
}

function logoutAccount(email) {
    if (confirm(`Logout ${email} from this device?`)) {
        // Remove from saved accounts
        const savedAccounts = JSON.parse(localStorage.getItem('roxli_accounts') || '[]');
        const loggedAccounts = JSON.parse(localStorage.getItem('roxli_logged_accounts') || '[]');
        
        // Remove from both storage arrays
        const updatedSaved = savedAccounts.filter(acc => acc.email !== email);
        const updatedLogged = loggedAccounts.filter(acc => acc !== email);
        
        localStorage.setItem('roxli_accounts', JSON.stringify(updatedSaved));
        localStorage.setItem('roxli_logged_accounts', JSON.stringify(updatedLogged));
        
        // Reload saved accounts to update dropdown
        loadSavedAccounts();
        
        showNotification(`${email} logged out from this device`);
    }
}

function openAuthPopupForSwitch(email) {
    const popup = window.open(`https://auth.roxli.in/popup?email=${encodeURIComponent(email)}`, 'roxli-auth', 'width=400,height=600');
    
    const messageHandler = function(event) {
        if (event.origin !== 'https://auth.roxli.in') return;
        
        if (event.data.type === 'ROXLI_AUTH_SUCCESS') {
            popup.close();
            window.removeEventListener('message', messageHandler);
            
            fetch('/api/set-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: event.data.token })
            })
            .then(() => window.location.reload());
        }
    };
    
    window.addEventListener('message', messageHandler);
}

function openSwitchPopup(email) {
    const popup = window.open('https://auth.roxli.in/popup', 'roxli-auth', 'width=400,height=600,scrollbars=yes,resizable=yes');
    
    const messageHandler = function(event) {
        if (event.origin !== 'https://auth.roxli.in') return;
        
        if (event.data.type === 'ROXLI_AUTH_SUCCESS') {
            popup.close();
            window.removeEventListener('message', messageHandler);
            
            fetch('/api/set-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: event.data.token })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const loggedAccounts = JSON.parse(localStorage.getItem('roxli_logged_accounts') || '[]');
                    if (!loggedAccounts.includes(event.data.user.email)) {
                        loggedAccounts.push(event.data.user.email);
                        localStorage.setItem('roxli_logged_accounts', JSON.stringify(loggedAccounts));
                    }
                    
                    window.location.reload();
                }
            });
        }
    };
    
    window.addEventListener('message', messageHandler);
}

function openSwitchPopup(email) {
    const popup = window.open(`https://auth.roxli.in/popup`, 'roxli-auth', 'width=400,height=600');
    
    const messageHandler = function(event) {
        if (event.origin !== 'https://auth.roxli.in') return;
        
        if (event.data.type === 'ROXLI_AUTH_SUCCESS') {
            popup.close();
            window.removeEventListener('message', messageHandler);
            
            fetch('/api/set-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: event.data.token })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                }
            });
        }
    };
    
    window.addEventListener('message', messageHandler);
}

function checkFirstTimeUser() {
    // Always try to send welcome email - server will check if it already exists
    console.log('Checking for welcome email...');
    setTimeout(sendWelcomeEmail, 1000);
}

function sendWelcomeEmail() {
    console.log('Sending welcome email...');
    fetch('/api/send-welcome-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        console.log('Welcome email response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Welcome email response:', data);
        if (data.success) {
            showNotification('Welcome to Roxli Mail! Check your inbox.');
            setTimeout(loadEmails, 2000);
        } else {
            console.error('Failed to send welcome email:', data.error);
            // Try again after delay
            setTimeout(sendWelcomeEmail, 5000);
        }
    })
    .catch(error => {
        console.error('Error sending welcome email:', error);
        // Try again after delay
        setTimeout(sendWelcomeEmail, 5000);
    });
}

document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.menu-toggle-btn');
    
    if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        if (sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
            sidebar.classList.add('hidden');
        }
    }
});

// Auto system theme detection
function setTheme() {
    const savedTheme = localStorage.getItem('roxli_mail_theme');
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme = savedTheme || systemTheme;
    document.documentElement.setAttribute('data-theme', theme);
}

// Set theme on load
setTheme();

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setTheme);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'c' && !e.ctrlKey && !e.metaKey) {
        window.location.href = '/compose';
    } else if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
        refreshMails();
    } else if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selectedEmails.size > 0) {
            deleteSelectedEmails();
        }
    } else if (e.key === 'a' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        selectAllMails();
    }
});

let currentView = 'inbox';
let autoRefreshInterval;

// Auto-refresh emails based on current view
function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(() => {
        refreshCurrentView();
        checkForNewEmails();
        checkForNotifications();
    }, 5000); // Check every 5 seconds for faster notifications
}

function refreshCurrentView() {
    switch(currentView) {
        case 'all':
            loadAllEmails();
            break;
        case 'inbox':
            loadEmails();
            break;
        case 'sent':
            loadSentEmails();
            break;
        case 'starred':
            loadStarredEmails();
            break;
        case 'drafts':
            loadDrafts();
            break;
        default:
            loadEmails();
    }
}

function setActiveView(view) {
    currentView = view;
    
    // Update active menu item
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-category="${view.charAt(0).toUpperCase() + view.slice(1)}"]`).classList.add('active');
    
    // Load the appropriate view
    refreshCurrentView();
}

function loadStarredEmails() {
    loadEmails();
    setTimeout(() => {
        filterCategory('Starred');
    }, 100);
}

function loadDrafts() {
    // For now, show empty drafts
    const emailList = document.getElementById('mailList');
    emailList.innerHTML = '<div style="padding: 40px; text-align: center; color: #5f6368;">No drafts</div>';
}

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showInstallButton();
});

function showInstallButton() {
    const installBtn = document.createElement('button');
    installBtn.innerHTML = '<i class="fa-solid fa-download"></i> Install App';
    installBtn.style.cssText = 'position: fixed; bottom: 80px; right: 20px; background: #1a73e8; color: white; border: none; padding: 12px 16px; border-radius: 25px; font-size: 14px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(26,115,232,0.3);';
    installBtn.onclick = installApp;
    document.body.appendChild(installBtn);
}

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((result) => {
            deferredPrompt = null;
            document.querySelector('[onclick="installApp()"]')?.remove();
        });
    }
}

function loadSentEmails() {
    fetch('/api/sent-emails')
        .then(response => response.json())
        .then(data => {
            if (data.emails) {
                emails = data.emails;
                renderSentEmails();
            }
        })
        .catch(error => console.error('Error loading sent emails:', error));
}

function renderSentEmails() {
    const emailList = document.getElementById('mailList');
    
    if (emails.length > 0) {
        emailList.innerHTML = emails.map(email => `
            <div class="email-item" data-id="${email.id}" data-category="Sent" onclick="openEmail('${email.id}')">
                <input type="checkbox" class="email-checkbox" onclick="event.stopPropagation(); selectEmail('${email.id}', this.checked)">
                <span class="email-star">📤</span>
                <div class="email-avatar">
                    <div class="avatar-initials" style="background-color: #667eea;">
                        ${email.to ? email.to[0].toUpperCase() : 'U'}
                    </div>
                </div>
                <div class="email-content">
                    <div class="email-header">
                        <div class="email-sender">To: ${email.to || 'Unknown'}</div>
                        <div class="email-time">${email.time || ''}</div>
                    </div>
                    <div class="email-subject">${email.subject || '(No subject)'}</div>
                    <div class="email-preview">${email.preview ? (email.preview.length > 50 ? email.preview.substring(0, 50) + '...' : email.preview) : ''}</div>
                </div>
            </div>
        `).join('');
    } else {
        emailList.innerHTML = '<div style="padding: 40px; text-align: center; color: #5f6368;">No sent emails</div>';
    }
}

// Check for new notifications from server
function checkForNotifications() {
    fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    showAdvancedNotification(notification);
                    
                    // Mark as read after showing
                    setTimeout(() => {
                        fetch('/api/mark-notification-read', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ notificationId: notification.id })
                        });
                    }, 1000);
                });
            }
        })
        .catch(error => {
            console.error('Error checking notifications:', error);
        });
}

// Advanced notification with better UI
function showAdvancedNotification(notification) {
    // Browser notification
    if (Notification.permission === 'granted') {
        const browserNotif = new Notification(notification.title, {
            body: notification.body,
            icon: '/static/images/logo.png',
            badge: '/static/images/logo.png',
            tag: 'roxli-mail-' + notification.id,
            requireInteraction: true,
            actions: [
                { action: 'view', title: 'View Email' },
                { action: 'dismiss', title: 'Dismiss' }
            ]
        });
        
        browserNotif.onclick = function() {
            if (notification.data && notification.data.email_id) {
                window.open(`/read/${notification.data.email_id}`, '_blank');
            }
            browserNotif.close();
        };
        
        // Auto close after 8 seconds
        setTimeout(() => browserNotif.close(), 8000);
    }
    
    // In-app notification
    showInAppNotification(notification);
}

// Enhanced in-app notification with better permission handling
function showInAppNotification(notification) {
    // Store notification in localStorage
    const storedNotifications = JSON.parse(localStorage.getItem('roxli_notifications') || '[]');
    storedNotifications.unshift({
        ...notification,
        timestamp: Date.now() / 1000
    });
    // Keep only last 50 notifications
    if (storedNotifications.length > 50) {
        storedNotifications.splice(50);
    }
    localStorage.setItem('roxli_notifications', JSON.stringify(storedNotifications));
    updateNotificationBadge();
    
    const notifContainer = document.createElement('div');
    notifContainer.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: linear-gradient(135deg, #1a73e8 0%, #667eea 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(26, 115, 232, 0.3);
        max-width: 350px;
        animation: slideInRight 0.3s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    `;
    
    notifContainer.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                📧
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px; line-height: 1.3;">${notification.title}</div>
                <div style="font-size: 13px; opacity: 0.9; line-height: 1.4;">${notification.body}</div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    ${notification.data && notification.data.email_id ? 
                        `<button onclick="window.open('/read/${notification.data.email_id}', '_blank'); this.closest('[style*="position: fixed"]').remove();" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">View Email</button>` : 
                        ''
                    }
                    <button onclick="this.closest('[style*="position: fixed"]').remove();" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">Dismiss</button>
                </div>
            </div>
            <button onclick="this.closest('[style*="position: fixed"]').remove();" style="background: none; border: none; color: rgba(255,255,255,0.8); font-size: 18px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0;">
                ×
            </button>
        </div>
    `;
    
    document.body.appendChild(notifContainer);
    
    // Auto remove after 10 seconds
    setTimeout(() => {
        if (notifContainer.parentNode) {
            notifContainer.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (notifContainer.parentNode) {
                    notifContainer.remove();
                }
            }, 300);
        }
    }, 10000);
}

// Add CSS animations
if (!document.querySelector('#notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

// Check for new emails and show notifications
function checkForNewEmails() {
    const lastEmailCount = localStorage.getItem('last_email_count') || '0';
    
    if (emails.length > parseInt(lastEmailCount)) {
        const newEmailsCount = emails.length - parseInt(lastEmailCount);
        if (newEmailsCount > 0 && parseInt(lastEmailCount) > 0) {
            showBrowserNotification(
                `${newEmailsCount} new email${newEmailsCount > 1 ? 's' : ''}`,
                'Click to view your inbox'
            );
        }
    }
    
    localStorage.setItem('last_email_count', emails.length.toString());
}

// Show browser notification
function showBrowserNotification(title, body) {
    if (Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body,
            icon: '/static/images/logo.png',
            badge: '/static/images/logo.png',
            tag: 'roxli-mail-new',
            requireInteraction: true
        });
        
        notification.onclick = function() {
            window.focus();
            notification.close();
        };
        
        // Auto close after 5 seconds
        setTimeout(() => {
            notification.close();
        }, 5000);
    }
}


</script>

</body>
</html>